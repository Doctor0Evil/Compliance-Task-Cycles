name: Resync Ingestion Guard

on:
  workflow_dispatch:
  push:
    paths:
      - ".bit/linking.repo.bit.yml"
      - "scripts/**"
      - "tools/**"

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Locate resync-ingestion script
        id: find
        run: |
          set -euo pipefail
          PATHS=$(yq -r '.contract.required_scripts[] | select(.id=="resync-ingestion") | (.prefer[]?, .alternates[]?)' .bit/linking.repo.bit.yml)
          FOUND=""
          while IFS= read -r p; do
            [[ -f "$p" ]] && { FOUND="$p"; break; }
          done <<< "$PATHS"
          if [[ -z "$FOUND" ]]; then
            echo "found=" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "found=$FOUND" >> $GITHUB_OUTPUT
          chmod +x "$FOUND" || true

      - name: Run resync-ingestion
        if: steps.find.outputs.found != ''
        run: "${{ steps.find.outputs.found }}"

      - name: Fail with remediation if missing
        if: steps.find.outputs.found == ''
        run: |
          cat <<'EOM'
❌ resync-ingestion script not found.
Add one of the following:
  - ./scripts/resync-ingestion.sh
  - ./.bit/loaders/resync-ingestion.sh
  - ./tools/resync-ingestion.sh
Or provide a PowerShell variant and update the contract:
  - ./scripts/resync-ingestion.ps1
Stub content (Bash):
  #!/usr/bin/env bash
  set -euo pipefail
  echo "[resync] nothing to do yet"
EOM
          exit 1
